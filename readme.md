# Implementation of Aaron's virtual machine

このプログラムは [Aaron 氏による仮想機械](https://takumim97.hatenablog.com/entry/2019/09/10/091018)の実装です。
アセンブリ言語形式で表現したものを実行します。

## 実行環境要件

Rust を用いて書いたものを Windows 10 (64 ビット版) 用にコンパイルしていますが、 Rust が対応している環境であればコンパイルしなおせば動く可能性は高いです。

## 原形と異なる部分

Aaron 氏が提案しているレジスタマシンとは以下のような部分で異なっています。

- 空命令は存在しません。
- 原形では命令が存在しない箇所は空命令があるものとみなしますが、このプログラムでは命令が存在しないインデックスが与えられるとエラーになります。
- メモリの初期状態を与える方法はありません。 必要であれば `save` 命令で陽に値を書き込む必要があります。
- レジスタ数の上限は 100000 です。 100000 以上の番号を持つレジスタに書き込みを試みた場合はエラーとして即終了します。 読み出しだけは可能です。

## 文法

このプログラムが解釈するプログラムの各行は以下のいずれかの形式をとります。

- `[ラベル] 空白 命令 空白 オペランド [空白] [; コメント]`
- `[空白] [; コメント]`

(ここでは `[` `]` で囲んだ要素は省略可能であることを表します) 

### 命令、及びオペランド

このプログラムで書くことのできる命令、及びそれぞれの命令が受け取ることのできるオペランドは以下の通りです。

- `incr index [, value]`
- `decr index ,address [, value]`
- `save index, value`
- `halt`

(ここでは `[` `]` で囲んだ要素は省略可能であることを表し、省略された場合には即値の `1` が与えられたものと見做します)

#### 命令

##### incr命令

`index` 番レジスタに格納されている値を `value` だけ増加させます。

##### save命令

`index` 番レジスタに `value` を格納します。

##### decr命令

`index` 番レジスタに格納されている値が `value` 以上ならば `index` 番レジスタに格納されている値を `value` だけ減らします。
そうでなければ `address` にジャンプします。

##### halt命令

プログラム全体の実行が終了し、その時点での 0 番レジスタの値がプログラム全体の返却値になります。

#### オペランドの表現

##### index

`index` としては二種類の表現が可能です。

|種類|記法|説明|
|---|---|---|
|直接記法|整数|記述された値を番地にもつレジスタを表す|
|関節記法| `[` 整数 `]` | `[` と `]` で囲まれた整数を番地にもつレジスタに格納されている値を番地にもつレジスタを表す。

##### value

`value` としては四種類の表現が可能です。

|種類|記法|説明|
|---|---|---|
|即値|整数|記述された値がそのまま値となる|
|レジスタ値| `[` 整数 `]` | `[` と `]` で囲まれた整数をもつレジスタに格納されている値を使う|
|ポインタ値| `[[` 整数 `]]` | `[[` と `]]` で囲まれた整数をもつレジスタに格納されている値を番地にもつレジスタに格納されている値を使う|
|プログラムカウンタ|pc|現在のプログラムカウンタの値を使う|
|ラベル|ラベル名|同名のラベルがつけられた命令のアドレスを即値で与えた場合と同じとみなす|

##### address

|種類|記法|説明|
|---|---|---|
|即値|整数|記述された値がそのまま値となる|
|レジスタ値| `[` 整数 `]` | `[` と `]` で囲まれた整数をもつレジスタに格納されている値を使う|
|プログラムカウンタ|pc|現在のプログラムカウンタの値を使う|
|ラベル|ラベル名|同名のラベルがつけられた命令のアドレスを表す|

## インストール方法

```console
$ git clone https://github.com/SaitoAtsushi/aaron-asm.git
$ cd aaron-asm
$ cargo install
```

## 実行方法

コマンドから、プログラムのファイル名を与えるとそれを解釈・実行して結果を標準出力に表示します。

```console
$ aaron-asm [filename]
```
